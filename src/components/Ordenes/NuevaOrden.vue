<template>
  <div>
    <svg
      id="svg-source"
      height="0"
      version="1.1"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      style="position: absolute"
    >
      <g
        id="shopping-cart"
        data-iconmelon="e-commerce icons:7c96e2dece0152dc594d66b260f79db0"
      >
        <path
          d="M22.463,25.841c0.528,0,0.918-0.429,0.918-0.958v-6.786c0-0.529-0.39-0.958-0.918-0.958c-0.529,0-0.92,0.429-0.92,0.958
	v6.786C21.543,25.413,21.934,25.841,22.463,25.841z M18.156,25.841c0.529,0,0.919-0.429,0.919-0.958v-6.786
	c0-0.529-0.39-0.958-0.919-0.958s-0.919,0.429-0.919,0.958v6.786C17.237,25.413,17.627,25.841,18.156,25.841z M13.851,25.841
	c0.528,0,0.919-0.429,0.919-0.958v-6.786c0-0.529-0.391-0.958-0.919-0.958c-0.529,0-0.919,0.429-0.919,0.958v6.786
	C12.932,25.413,13.321,25.841,13.851,25.841z M29.426,8.511h-5.327l-2.731-4.396c-0.342-0.593-0.98-0.961-1.666-0.961
	c-0.336,0-0.668,0.089-0.959,0.258c-0.918,0.529-1.233,1.707-0.689,2.647l1.564,2.451h-7.976l1.58-2.475
	c0.529-0.917,0.214-2.095-0.704-2.624c-0.292-0.169-0.623-0.258-0.959-0.258c-0.686,0-1.323,0.368-1.655,0.943L7.161,8.511H2.574
	C1.155,8.511,0,9.667,0,11.086v1.47c0,1.274,0.934,2.525,2.152,2.728l1.931,11.042c0.03,1.394,1.173,2.519,2.573,2.519h18.605
	c1.401,0,2.545-1.125,2.574-2.52l1.921-11.032C31.019,15.128,32,13.862,32,12.556v-1.47C32,9.667,30.845,8.511,29.426,8.511z
	M26.615,26.167l-0.009,0.104c0,0.741-0.604,1.344-1.345,1.344H6.656c-0.741,0-1.344-0.603-1.344-1.344L3.407,15.327h25.096
	L26.615,26.167z M30.77,12.556c0,0.74-0.603,1.541-1.344,1.541H2.574c-0.741,0-1.344-0.8-1.344-1.541v-1.47
	c0-0.741,0.603-1.344,1.344-1.344h5.271l3.113-5.011c0.184-0.318,0.623-0.439,0.944-0.253c0.33,0.19,0.444,0.614,0.268,0.92
	L9.396,9.742h12.467l-2.76-4.32c-0.189-0.33-0.076-0.753,0.253-0.944c0.323-0.186,0.756-0.074,0.955,0.27l3.104,4.994h6.011
	c0.741,0,1.344,0.603,1.344,1.344V12.556z M9.545,25.841c0.528,0,0.918-0.429,0.918-0.958v-6.786c0-0.529-0.39-0.958-0.918-0.958
	c-0.529,0-0.919,0.429-0.919,0.958v6.786C8.626,25.413,9.016,25.841,9.545,25.841z"
        ></path>
      </g>
      <g
        id="credit-card"
        data-iconmelon="e-commerce icons:c3144b166f93e0f6b73aee04a0a48397"
      >
        <path
          d="M29.018,4.751H2.981C1.337,4.751,0,6.089,0,7.733v16.534c0,1.644,1.337,2.981,2.981,2.981h26.036
	c1.645,0,2.982-1.338,2.982-2.981V7.733C32,6.089,30.662,4.751,29.018,4.751z M30.638,24.267c0,0.893-0.727,1.62-1.621,1.62H2.981
	c-0.893,0-1.62-0.727-1.62-1.62V13.603h29.276V24.267z M30.638,10.236H1.362V7.733c0-0.894,0.727-1.62,1.62-1.62h26.036
	c0.894,0,1.621,0.727,1.621,1.62V10.236z M8.848,22.494H2.724v1.338h6.124V22.494z M19.043,22.494H9.548v1.338h9.495V22.494z"
        ></path>
      </g>
      <g id="person">
        <path
          d="M313.6 304c-28.7 0-42.5 16-89.6 16-47.1 0-60.8-16-89.6-16C60.2 304 0 364.2 0 438.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-25.6c0-74.2-60.2-134.4-134.4-134.4zM400 464H48v-25.6c0-47.6 38.8-86.4 86.4-86.4 14.6 0 38.3 16 89.6 16 51.7 0 74.9-16 89.6-16 47.6 0 86.4 38.8 86.4 86.4V464zM224 288c79.5 0 144-64.5 144-144S303.5 0 224 0 80 64.5 80 144s64.5 144 144 144zm0-240c52.9 0 96 43.1 96 96s-43.1 96-96 96-96-43.1-96-96 43.1-96 96-96z"
        ></path>
      </g>
    </svg>
    <b-modal id="nuevaOrden" centered title="Nueva Orden">
      <div class="cuerpoModal">
        <div class="sideBarMenu">
          <b-list-group style="max-width: 13rem">
            <b-list-group-item
              class="d-flex align-items-center"
              :class="{ tabSelected: paso === 'datos' }"
              @click="paso = 'datos'"
            >
              <b-avatar variant="success" class="mr-3">
                <svg
                  viewBox="50 100 300 300"
                  width="1em"
                  height="1em"
                  focusable="false"
                  role="img"
                  aria-label="person fill"
                  aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="currentColor"
                  class="b-icon bi"
                >
                  <g filter="">
                    <use xlink:href="#person"></use>
                  </g>
                </svg>
              </b-avatar>
              <span class="mr-auto">Datos Personales</span>
            </b-list-group-item>
            <b-list-group-item
              class="d-flex align-items-center"
              :class="{ tabSelected: paso === 'productos' }"
              @click="paso = 'productos'"
            >
              <b-avatar variant="success" class="mr-3">
                <svg
                  viewBox="7 7 16 16"
                  width="1em"
                  height="1em"
                  focusable="false"
                  role="img"
                  aria-label="person fill"
                  aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="currentColor"
                  class="b-icon bi"
                >
                  <g filter="">
                    <use xlink:href="#shopping-cart"></use>
                  </g>
                </svg>
              </b-avatar>
              <span class="mr-auto">Agregar Productos</span>
            </b-list-group-item>
            <b-list-group-item
              class="d-flex align-items-center"
              :class="{ tabSelected: paso === 'resumen' }"
              @click="paso = 'resumen'"
            >
              <b-avatar variant="success" class="mr-3">
                <svg
                  viewBox="7 7 16 16"
                  width="1em"
                  height="1em"
                  focusable="false"
                  role="img"
                  aria-label="person fill"
                  aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="currentColor"
                  class="b-icon bi"
                >
                  <g filter="">
                    <use xlink:href="#credit-card"></use>
                  </g>
                </svg>
              </b-avatar>
              <span class="mr-auto">Pagar Orden</span>
            </b-list-group-item>
          </b-list-group>
        </div>
        <div class="bodyMenu">
          <div class="datosPersonales" v-if="paso === 'datos'">
            <b-form class="d-flex justify-content-center mb-4 mt-5" inline>
              <label for="fecha">Fecha de venta:&nbsp;&nbsp;&nbsp; </label>
              <date-pick
                id="fecha"
                v-model="date"
                :inputAttributes="{ readonly: true }"
                :pickTime="true"
                :use12HourClock="true"
                :format="'DD-MM-YYYY HH:mm'"
                :displayFormat="'DD-MM-YYYY H:mm A'"
                :selectableYearRange="{ from: 2020, to: 2030 }"
              ></date-pick>
            </b-form>
            <b-form class="justifySpace" inline>
              <div>
                <label for="nombre">Nombre:&nbsp;&nbsp;&nbsp; </label>
                <b-form-input
                  id="nombre"
                  class="mb-2 mr-sm-2 mb-sm-0"
                  v-model="orden.nombreCliente"
                ></b-form-input>
              </div>
              <div>
                <label for="tel">Teléfono:&nbsp;&nbsp;&nbsp; </label>
                <b-form-input
                  id="tel"
                  class="mb-2 mr-sm-2 mb-sm-0"
                  v-model="orden.telefono"
                ></b-form-input>
              </div>
            </b-form>
            <b-form class="d-flex justify-content-center mb-4 mt-5" inline>
              <div>
                <label for="tipoOrdenDropDown"
                  >Tipo de orden:&nbsp;&nbsp;&nbsp;
                </label>
                <dropdown
                  id="tipoOrdenDropDown"
                  class="dropdown"
                  :options="tipoOrdenArray"
                  :selected="tipoOrden"
                  v-on:updateOption="tipoOrdenMethod"
                  :placeholder="'Público'"
                  :closeOnOutsideClick="true"
                >
                </dropdown>
              </div>
            </b-form>
            <div>
              <blockquote>
                <p><b>Público:</b> Todos los clientes.</p>

                <p>
                  <b>Mayorista:</b> Cuando la compra de productos excede lo
                  normal.
                </p>

                <p>
                  <b>Taller:</b> Cuando un taller asociado realiza una compra.
                </p>
              </blockquote>
            </div>
          </div>
          <div class="selProductos" v-show="paso === 'productos'">
            <input type="search" placeholder="Buscar" v-model="buscar" />
            <vue-good-table
            title="Agrega Producto al Carrito"
              :columns="columns"
              :rows="productos"
              max-height="50vh"
              :fixed-header="true"
              :search-options="{
                enabled: true,
                externalQuery: buscar,
              }"
            >
              <template slot="table-row" slot-scope="props">
                <span v-if="props.column.field == 'cantidad'" class="borrar2doSpan">
                  <input
                    type="number"
                    id="cantidadProducto"
                    min="0"
                    :max="props.row.stockProd"
                    value="0"
                    size="6"
                    class="form-control"
                    v-model="props.row.cantidad"
                    onKeyDown="return false"
                    @change="changeProd($event, props.row)"
                  />
                  <!-- <b-form-spinbutton
                    id="cantidadProducto"
                    v-model="props.row.cantidad"
                    min="0"
                    :max="props.row.stockProd"
                    placeholder="0"
                    @change="changeProd($event, props.row)"
                  ></b-form-spinbutton> -->
                </span>
                <span v-if="props.column.field == 'total'">
                  {{
                    props.row.cantidad * props.row.precioUnit > 0
                      ? props.row.cantidad * props.row.precioUnit
                      : "0"
                  }}
                </span>
                <span v-else>
                  {{ props.formattedRow[props.column.field] }}
                </span>
              </template>
            </vue-good-table>
          </div>
        </div>
      </div>
      <template #modal-footer="{ cancel, ok }">
        <b-button
          size="m"
          variant="secondary"
          @click="cancel()"
          v-if="paso === 'datos'"
        >
          Cancelar
        </b-button>
        <b-button
          size="m"
          variant="warning"
          @click="paso = 'datos'"
          v-if="paso === 'productos'"
          class="text-dark"
        >
          Atras
        </b-button>
        <b-button
          size="m"
          variant="warning"
          @click="paso = 'productos'"
          v-if="paso === 'resumen'"
        >
          Atras
        </b-button>
        <b-button
          size="m"
          variant="success"
          @click="paso = 'productos'"
          v-if="paso === 'datos'"
        >
          Siguiente
        </b-button>
        <b-button
          size="m"
          variant="success"
          @click="paso = 'resumen'"
          v-if="paso === 'productos'"
        >
          Siguiente
        </b-button>
        <b-button
          size="m"
          variant="success"
          @click="
            ok();
            paso = 'datos';
          "
          v-if="paso === 'resumen'"
        >
          Confirmar
        </b-button>
      </template>
    </b-modal>
  </div>
</template>
<script>
import dropdown from "vue-dropdowns";
import DatePick from "@/components/Calendario/vueDatePick.vue";
import "vue-good-table/dist/vue-good-table.css";
import { VueGoodTable } from "vue-good-table";
import { mapState, mapMutations } from "vuex";

export default {
  name: "NuevaOrden",
  components: {
    dropdown,
    DatePick,
    VueGoodTable,
  },
  data() {
    return {
      headerLabels: [
        { key: "upc", label: "UPC" },
        { key: "nombreProd", label: "Nombre" },
        { key: "nombreMarca", label: "Marca" },
        { key: "nombreCategoria", label: "Categoria" },
        { key: "precioUnit", label: "P. U." },
        "cantidad",
        "descuento",
        {
          key: "total",
          label: "Total",
          formatter: (a, b, item) => {
            return (
              item.cantidad * item.precioUnit -
              item.cantidad * item.precioUnit * (item.descuento / 100)
            ).toFixed(2);
          },
        },
      ],
      columns: [
        { field: "upc", label: "UPC" },
        { field: "nombreProd", label: "Nombre" },
        { field: "nombreMarca", label: "Marca" },
        { field: "nombreCategoria", label: "Categoria" },
        {
          field: "precioUnit",
          label: "P. U.",
          type: "number",
          globalSearchDisabled: true,
        },
        {
          field: "cantidad",
          label: "Cantidad",
          globalSearchDisabled: true,
          type: "number",
        },
        {
          field: "total",
          label: "Total",
          globalSearchDisabled: true,
        },
      ],
      buscar: "",
      object: {
        name: "Efectivo",
      },
      paso: "datos",
      date: "20-01-2021 14:30",
      tipoOrdenArray: [
        {
          name: "Público",
        },
        {
          name: "Mayoreo",
        },
        {
          name: "Taller",
        },
      ],
      tipoOrden: {
        name: "Público",
      },
    };
  },
  methods: {
    ...mapMutations("ordenes", [
      "change",
      "decProducto",
      "incProducto",
      "filtroProd",
      "dosDecimalesProd",
    ]),
    methodToRunOnSelect(payload) {
      console.log("hola");
      this.object = payload;
    },
    tipoOrdenMethod(payload) {
      this.tipoOrden = payload;
    },
    changeProd(cantidad, producto) {
      console.log(producto.cantidad, producto.precioUnit);
      producto.total = producto.cantidad * producto.precioUnit;
      this.$nextTick(() => {});
      console.log(cantidad);
      console.log(producto);
    },
  },
  computed: {
    ...mapState("ordenes", ["ordSelected", "showDetOrd", "orden", "metPago"]),
    ...mapState("productos", ["productos"]),
  },
  mounted() {
    this.date = todayDate();
  },
};
function todayDate() {
  var today = new Date();
  var dd = String(today.getDate()).padStart(2, "0");
  var mm = String(today.getMonth() + 1).padStart(2, "0"); //January is 0!
  var yyyy = today.getFullYear();
  var horas = today.getHours();
  var minutos = today.getMinutes();
  return `${dd}-${mm}-${yyyy} ${horas}:${minutos}`;
}
</script>

<style scoped>
::v-deep .modal-dialog {
  max-width: 100% !important;
  height: 100%;
  margin: 0;
  padding: 0 !important;
  overflow-y: initial !important;
}

::v-deep .modal-content {
  height: 100% !important;
}
::v-deep .modal-body {
  height: 80vh;
  overflow-y: auto;
}
::v-deep .bg-success {
  background-image: radial-gradient(
    circle farthest-corner at 50.4% 50.5%,
    #0eae57 0%,
    rgb(0 123 57) 90%
  );
}
::v-deep .modal-header {
  /* box-shadow: 0 0.125rem 0.8rem rgb(0 0 0 / 10%); */
  box-shadow: 13rem 0rem 0.8rem rgb(0 0 0 / 10%);
}
::v-deep .modal-footer {
  /* box-shadow: 0.125rem -0.8rem 20px 0px rgb(0 0 0 / 10%); */
  box-shadow: 13rem -0.8rem 20px 0px rgb(0 0 0 / 10%);
}
::v-deep .modal-title {
  padding-left: 2.5rem;
}
.roundedBorder {
  border-radius: calc(1rem - 1px) calc(1rem - 1px) 0 0;
}
/* para el dropdown */
::v-deep .dropdown-menu > li > a:hover {
  background: #efefef;
  color: #002696;
}
::v-deep .dropdown-menu {
  display: block;
}
::v-deep li.dropdown-toggle::after {
  display: none;
}
/* Body del modal */
::v-deep .modal-body {
  padding: 0%;
}
.cuerpoModal {
  display: inline;
  padding: 0%;
}
::v-deep .list-group-item {
  transition: none;
  border: none;
  cursor: pointer;
  user-select: none;
}
.sideBarMenu {
  display: inline-flex;
  height: 100%;
  width: 13rem;
  align-items: center;
  padding: 0;
  margin: 0;
  border-right: 1px solid #dfdfdf;
  box-shadow: 0 0.125rem 0.8rem rgb(0 0 0 / 10%);
}
.bodyMenu {
  display: inline-block;
  height: 100%;
  width: calc(100% - 13rem);
  vertical-align: top;
  position: relative;
}
.tabSelected {
  transition: 0.1s ease-in-out all !important;
  border-right: 0.5rem solid #28a745;
}
.datosPersonales {
  padding-left: 2rem;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 100%;
}
::v-deep .vdpComponent input[type="text"] {
  text-align: center;
  font-size: medium;
  font-family: revert;
  /* font-weight: bold; */
  padding: 0.4rem 0.8rem;
  line-height: 1.5;
  background-color: #fff;
  border: 1px solid #ced4da;
  border-radius: 2rem;
  -webkit-transition: border-color 0.15s ease-in-out,
    -webkit-box-shadow 0.15s ease-in-out;
  transition: border-color 0.15s ease-in-out,
    -webkit-box-shadow 0.15s ease-in-out;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out,
    -webkit-box-shadow 0.15s ease-in-out;
}
.justifySpace {
  justify-content: space-between;
  width: 100%;
}
.fechaForm {
  float: right;
  margin: 1rem;
}
.dropdown {
  text-align: center;
}
blockquote {
  color: rgba(0, 0, 0, 0.5);
  padding-left: 1.5em;
  border-left: 5px solid rgba(0, 0, 0, 0.1);
}
.selProductos {
  padding: 2rem;
  width: 100%;
  height: 100%;
}
/* search input */
input {
  outline: none;
}
input[type="search"] {
  margin-bottom: 1rem;
  -webkit-appearance: textfield;
  -webkit-box-sizing: content-box;
  box-sizing: content-box;
  font-family: inherit;
  font-size: 100%;
}
input::-webkit-search-decoration,
input::-webkit-search-cancel-button {
  display: none;
}

input[type="search"] {
  background: #ededed
    url(https://static.tumblr.com/ftv85bp/MIXmud4tx/search-icon.png) no-repeat
    9px center;
  border: solid 1px #ccc;
  padding: 9px 10px 9px 32px;
  width: 55px;

  -webkit-border-radius: 10em;
  -moz-border-radius: 10em;
  border-radius: 10em;

  -webkit-transition: all 0.5s;
  -moz-transition: all 0.5s;
  transition: all 0.5s;
}
input[type="search"]:focus {
  width: 30vw;
  background-color: #fff;
  border-color: #66cc75;

  -webkit-box-shadow: 0 0 5px rgba(109, 207, 246, 0.5);
  -moz-box-shadow: 0 0 5px rgba(109, 207, 246, 0.5);
  box-shadow: 0 0 5px rgba(109, 207, 246, 0.5);
}

input:-moz-placeholder {
  color: #999;
}
input::-webkit-input-placeholder {
  color: #999;
}
/* fin del search input */
/* inicio del spinbuttom */
::v-deep .b-form-spinbutton.form-control.d-flex.align-items-stretch button {
  color: black;
  padding: 0.3rem;
  transition: all 0.5s ease;
}

::v-deep .b-form-spinbutton .btn:not([class*="outline"]):hover,
::v-deep .b-form-spinbutton .btn:not([class*="outline"]):focus {
  color: #000 !important;
  font-size: large;
}
::v-deep .b-form-spinbutton output {
  padding: 0;
}
/* fin del spinbuttom */
.descuento {
  max-width: 5rem;
}
/* Para eliminar el extra espan que se muestra en la tabla de productos */
::v-deep #vgt-table > tbody > tr > td > span:nth-child(2)  {
  display: none;
}

/* Fin del body del modal */
</style>